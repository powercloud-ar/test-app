name: Build, Push Docker Image, Deploy and Stress Test
on:
  push:
    branches:
      - main
permissions:
  contents: write
  
jobs:
  # ==============================
  # 1. Build y Push de Docker
  # ==============================
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.build_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Generate build version
        id: version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          BUILD_VERSION=1.0.$COMMIT_COUNT
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "::set-output name=build_version::$BUILD_VERSION"
          echo "Build version: $BUILD_VERSION"
          
      - name: Notify Deploy
        env:
          DYNATRACE_TOKEN: ${{ secrets.DYNA_TOKEN }}
          DYNATRACE_TENANT: ${{ secrets.DYNA_TENANT }}
        run: |
          curl -X POST "https://$DYNATRACE_TENANT.live.dynatrace.com/platform/ingest/v1/events.sdlc" \
            -H "Authorization: Api-Token $DYNATRACE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "source": "GitHub Actions",
              "event.type": "build",
              "event.provider": "github",
              "event.status": "started",
              "task.name": "GitHub Workflow",
              "task.outcome": "running",
              "vcs.repository.url.full": "https://github.com/martiroman/test-nodejs-app.git",
              "execution_context": {
                  "buildId": "'"$BUILD_VERSION"'",
                  "repository": "test-nodejs-app"
                }
            }'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Install dependencies
        working-directory: ./src
        run: npm install

      - name: Build project
        working-directory: ./src
        run: npm run build --if-present
          
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: | 
            ${{ secrets.DOCKERHUB_USERNAME }}/mi-app-node:${{ env.BUILD_VERSION }}   
            ${{ secrets.DOCKERHUB_USERNAME }}/mi-app-node:latest
  # ==============================
  # 2Ô∏è. Stress Test Pre-Deploy
  # ==============================
  stress-test-pre:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run stress test (Pre-Deploy)
        run: |
          docker run --rm -i loadimpact/k6 run - < ./stress-tests/test-script.js \
            --env TARGET_URL=https://tienda.rocketcloud.io/

      - name: Notify error
        if: failure()    
        run: |
            curl -X POST "https://$DYNATRACE_TENANT.live.dynatrace.com/platform/ingest/v1/events.sdlc" \
              -H "Authorization: Api-Token $DYNATRACE_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                  "source": "GitHub Actions",
                  "event.type": "cicd.pipeline",
                  "event.provider": "github",
                  "event.status": "finished",
                  "task.name": "GitHub Workflow",
                  "task.outcome": "error",
                  "vcs.repository.url.full": "https://github.com/martiroman/test-nodejs-app.git",
                  "execution_context": {
                      "buildId": "'"$BUILD_VERSION"'",
                      "repository": "test-nodejs-app"
                    }
              }'
              
  # ==============================
  # 3. Notificacion a Dynatrace
  # ==============================
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: success()
    env:
      BUILD_VERSION: ${{ needs.build-and-push.outputs.build-version }}
      DYNATRACE_TOKEN: ${{ secrets.DYNA_TOKEN }}
      DYNATRACE_TENANT: ${{ secrets.DYNA_TENANT }}
    steps:
      - name: Notify success
        run: |
            curl -X POST "https://$DYNATRACE_TENANT.live.dynatrace.com/platform/ingest/v1/events.sdlc" \
              -H "Authorization: Api-Token $DYNATRACE_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                  "source": "GitHub Actions",
                  "event.type": "cicd.pipeline",
                  "event.provider": "github",
                  "event.status": "finished",
                  "task.name": "GitHub Workflow",
                  "task.outcome": "success",
                  "vcs.repository.url.full": "https://github.com/martiroman/test-nodejs-app.git", 
                  "execution_context": {
                      "buildId": "'"$BUILD_VERSION"'",
                      "repository": "test-nodejs-app"
                    }
              }'
          
      
