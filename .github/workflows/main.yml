name: Build, Push Docker Image, Deploy and Stress Test
on:
  push:
    branches:
      - main
permissions:
  contents: write
  
jobs:
  # ==============================
  # 1. Build y Push de Docker
  # ==============================
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.build_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
      
      - name: Notify Dynatrace Pre-Deploy
        env:
          DYNATRACE_TOKEN: ${{ secrets.DYNA_TOKEN }}
          DYNATRACE_TENANT: ${{ secrets.DYNA_TENANT }}
        run: |
          curl -X POST "https://$DYNATRACE_TENANT.live.dynatrace.com/platform/ingest/v1/events.sdlc" \
            -H "Authorization: Api-Token $DYNATRACE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
            "source": "GitHub Actions",
            "event.type": "Demo test-nodejs-app",
            "event.status": "started",
            "title": "Deploy en QA"
          }'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/package-lock.json

      - name: Install dependencies
        working-directory: ./src
        run: npm install

      - name: Build project
        working-directory: ./src
        run: npm run build --if-present

      - name: Generate build version
        id: version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          BUILD_VERSION=1.0.$COMMIT_COUNT
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "::set-output name=build_version::$BUILD_VERSION"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mi-app-node:${{ env.BUILD_VERSION }}
     
      - name: Generate build version
        id: versionbuild
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          BUILD_VERSION=1.0.$COMMIT_COUNT
          echo "::set-output name=build_version::$BUILD_VERSION"
          echo "Build version: $BUILD_VERSION"
    
  # ==============================
  # 2️. Stress Test Pre-Deploy
  # ==============================
  stress-test-pre:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run stress test (Pre-Deploy)
        run: |
          docker run --rm -i loadimpact/k6 run - < ./stress-tests/test-script.js \
            --env TARGET_URL=https://tienda.rocketcloud.io/
            
  # ==============================
  # 3️. Deploy via ArgoCD
  # ==============================
  deploy-argocd:
    runs-on: ubuntu-latest
    needs: [build-and-push, stress-test-pre]
    env:
      BUILD_VERSION: ${{ needs.build-and-push.outputs.build-version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update deploy.yaml
        run: |
          DEPLOY_FILE=conf-k8s/deploy.yaml
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/mi-app-node:latest
          BUILD_VERSION=${{ env.BUILD_VERSION }}

          sed -i "s|image: .*|image: $IMAGE_NAME|g" $DEPLOY_FILE
          sed -i "s|buildVersion: .*|buildVersion: $BUILD_VERSION|g" $DEPLOY_FILE

      - name: Commit updated deploy.yaml
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add conf-k8s/deploy.yaml
          git commit -m "Update buildVersion to $BUILD_VERSION and Docker image" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Install ArgoCD CLI
        run: |
          sudo curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo chmod +x /usr/local/bin/argocd

      - name: Wait ArgoCD Sync
        env:
          ARGOCD_USER: ${{ secrets.ARGOCD_USER }}
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN: ${{ secrets.ARGOCD_TOKEN }}
        run: |
          argocd login $ARGOCD_SERVER --username $ARGOCD_USER --password $ARGOCD_TOKEN --skip-test-tls
          argocd app get test-nodejs-app --refresh
          argocd app sync test-nodejs-app
          argocd app wait test-nodejs-app --timeout 60 --sync
          argocd app wait test-nodejs-app --timeout 600 --health

  # ==============================
  # 4️. Stress Test Post-Deploy
  # ==============================
  stress-test-post:
    runs-on: ubuntu-latest
    needs: deploy-argocd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run stress test (Post-Deploy)
        run: |
          docker run --rm -i loadimpact/k6 run - < ./stress-tests/test-script.js \
            --env TARGET_URL=https://tienda.rocketcloud.io/
            
  # ==============================
  # 5. Dynatrace notify
  # ==============================
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-push, stress-test-pre, deploy-argocd, stress-test-post]
    if: always()
    steps:
      - name: Notify success
        if: success()
        env:
          DYNATRACE_TOKEN: ${{ secrets.DYNA_TOKEN }}
          DYNATRACE_TENANT: ${{ secrets.DYNA_TENANT }}
        run: |
            curl -X POST "https://$DYNATRACE_TENANT.live.dynatrace.com/platform/ingest/v1/events.sdlc" \
              -H "Authorization: Api-Token $DYNATRACE_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
              "source": "GitHub Actions",
              "event.type": "Demo test-nodejs-app",
              "event.status": "finished",
              "title": "OK - Deploy en QA"
            }'

      - name: Notify error
        if: failure()    
        env:
          DYNATRACE_TOKEN: ${{ secrets.DYNA_TOKEN }}
          DYNATRACE_TENANT: ${{ secrets.DYNA_TENANT }}
        run: |
            curl -X POST "https://$DYNATRACE_TENANT.live.dynatrace.com/platform/ingest/v1/events.sdlc" \
              -H "Authorization: Api-Token $DYNATRACE_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
              "source": "GitHub Actions",
              "event.type": "Demo test-nodejs-app",
              "event.status": "failed",
              "title": "Error - Deploy en QA"
            }'
